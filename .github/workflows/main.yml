name: Lint and Format

on:
  push:
    branches: [action]

env:
  # Node.js 24 latest LTS version
  NODE_VERSION: '24'

permissions:
  contents: read
  pull-requests: read
  checks: write

jobs:
  lint:
    name: Lint and Format
    runs-on: ubuntu-latest

    steps:
      # Checkout code
      - name: Checkout code
        id: checkout-code
        uses: actions/checkout@v5
        with:
          show-progress: true

      # Setup Node.js
      - name: Setup Node.js
        id: setup-nodejs
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: 'package-lock.json'

      # Install dependencies with retry logic and error handling
      - name: Install npm dependencies
        id: setup-npm-dependencies
        run: |
          echo "🔧 Installing npm dependencies..."

          # Set npm registry to ensure we're using the official one
          npm config set registry https://registry.npmjs.org/

          # Clear npm cache first
          npm cache clean --force

          # Try to install with npm ci first (faster and more reliable)
          echo "📦 Attempting npm ci installation..."
          if npm ci --prefer-offline --no-audit; then
            echo "✅ npm ci installation successful"
          else
            echo "⚠️ npm ci failed, trying npm install..."
            
            # Fallback to npm install if npm ci fails
            if npm install --prefer-offline --no-audit; then
              echo "✅ npm install successful"
            else
              echo "❌ npm install also failed, trying with different registry..."
              
              # Try with alternative registry as last resort
              npm config set registry https://registry.npmjs.com/
              if npm install --prefer-offline --no-audit; then
                echo "✅ npm install with alternative registry successful"
              else
                echo "💥 All npm installation methods failed"
                exit 1
              fi
            fi
          fi

          echo "🎉 Dependencies installed successfully!"

      # Prettier Format Check (using local .prettierrc and .prettierignore)
      - name: Check Prettier formatting
        id: prettier-check
        run: |
          echo "🔍 Checking Prettier formatting using local config..."
          echo "📁 Using .prettierrc for formatting rules"
          echo "📁 Using .prettierignore for ignored files"
          npm run format:check
          echo "✅ Prettier formatting check completed"

      # ESLint Check (using local eslint.config.js)
      - name: Run ESLint
        id: eslint-check
        run: |
          echo "🔍 Running ESLint using local eslint.config.js..."
          echo "📁 Using eslint.config.js for linting rules"
          npm run lint
          echo "✅ ESLint check completed"

      # Display results summary
      - name: Display results summary
        run: |
          echo "🎉 All checks completed!"
          echo "✅ Prettier: Formatting check passed (using .prettierrc)"
          echo "✅ ESLint: Code quality check passed (using eslint.config.js)"
          echo "📁 Configuration files used:"
          echo "   - .prettierrc (strict formatting rules)"
          echo "   - .prettierignore (ignored files)"
          echo "   - eslint.config.js (linting rules)"
          echo "   - .lintstagedrc.js (pre-commit hooks)"
