name: Lint and Format

on:
  push:
    branches: [action]

env:
  NODE_VERSION: '20'

permissions:
  contents: read
  # Need to add these 2 for eslint-annotate-action
  pull-requests: read
  checks: write

jobs:
  lint:
    name: Lint and Format
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run ESLint and Prettier checks
        id: checks
        run: |
          echo "Running ESLint check..."
          npm run lint 2>&1
          eslint_exit_code=$?

          echo "Running Prettier format check..."
          npm run format:check 2>&1
          prettier_exit_code=$?

          # Store exit codes for later use
          echo "eslint_exit_code=$eslint_exit_code" >> $GITHUB_OUTPUT
          echo "prettier_exit_code=$prettier_exit_code" >> $GITHUB_OUTPUT

          # Continue regardless of check results to display all findings

      - name: Save Code Linting Report JSON
        # npm script for ESLint
        # eslint --output-file eslint_report.json --format json src
        # See https://eslint.org/docs/user-guide/command-line-interface#options
        run: npm run lint:report
        # Continue to the next step even if this fails
        continue-on-error: true

      - name: ESLint Annotate from Report JSON
        uses: ataylorme/eslint-annotate-action@3.0.0
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          report-json: 'eslint_report.json'

      - name: Display ESLint results
        if: steps.checks.outputs.eslint_exit_code != '0'
        run: |
          echo "❌ ESLint found the following issues:"
          npm run lint

      - name: Display Prettier results
        if: steps.checks.outputs.prettier_exit_code != '0'
        run: |
          echo "❌ Prettier found the following formatting issues:"
          npm run format:check

      - name: Display success message
        if: steps.checks.outputs.eslint_exit_code == '0' && steps.checks.outputs.prettier_exit_code == '0'
        run: |
          echo "✅ All checks passed successfully!"
          echo "✅ ESLint: No issues found"
          echo "✅ Prettier: No formatting issues found"
